# AHC013

## Contest Link
- https://atcoder.jp/contests/ahc013

## やったこと

### 2022/08/11

#### sample_submission.cpp の大部分を真似する
- ありがたい
- (多分) 26047 点
#### ランダム解の生成をできるだけ繰り返して最良のものを選ぶように変更
- [AHC011の現時点におけるC++得点1位のコード](https://atcoder.jp/contests/ahc011/submissions/32267675) のTime関係を参考に
- 42509 点
#### connect 回数を減らして move 回数を増やしたらスコアが増えた
- 43592 点
#### 山登り法を実装したい
- 初期状態はランダム解そのままでOKそう
- 遷移が良くわからない
- 例えば move 回数を固定して一部の move を変更する、みたいなことをする場合、ある move がその後の move に影響を与える(各操作が独立ではない)
- とりあえず move のうち1つをランダムに決めて、それは確実に変化させ、他はそれまでの操作によって出来なくなってたら変化させるみたいなことをすることにする
- さらに適宜 additional_move_limit で move 回数を増やしたりする
- modify() がそれだけど、while(true)があることもあり結構無駄が多そう(特に空きマスが少ない場合)
    - そもそもこれいる？
- とりあえず 73033 点
- AtCoder のコードテストで動かすとSeed=1,N=30,K=3,に対して256回ループが回っているが、手元では45回くらい(途中経過の出力含む)
    - 手元では60秒くらい走らせたほうが良さそう
    - `g++ -std=gnu++17 a.cpp -o a.out -D_RUTHEN`
    - 300 秒くらい走らせたところ、まだ解が収束してなかった
        - 定数倍高速化も重要そう

#### calc_score の高速化
- 同じ種類のコンピュータにしか繋がないことにすると $N$ 成分からなる連結成分全体のスコアは $ \binom{N}{2} $ なのでこれを使って高速化する
- AtCoder のコードテストで山登り法のループ回数が256から130000回くらいに(はっや)
- めちゃくちゃ得点伸びた (202557 点)
- ひとまず山登り法で局所解には到達してそう?
- 焼きなまし法やっていく
- 異なる種類のコンピュータに繋いだほうが良いことはないとしているが、本当か?


### 2022/08/12

#### 焼きなまし法を実装したい
- あらかじめ[誰でもできる焼きなまし法][gasin]を参照していたので割と変更は楽だった
- start_time, end_timeというのがよくわからない
- 5, 0にしたら1ケースだけWA……
- assert入れまくったら今度は通って意味不明
    - バグを埋め込んでいるかも……
        - modify周りっぽい気がするので直す
    - しかもスコアは下がった (142196点)
    - 多分焼きまわし時間が足りてない

#### modify関数を変える
- とりあえずmove数が減るようにもした(よく見たら増やしてばっかりだった、やばい)
- それに伴って move 数が0になったときの処理などが追加で必要になった
- 相変わらずスコアは伸びない (156491点)

#### パラメータ弄り
- こんな段階でやるべきではないんですが……

| start_temp | end_temp | score |
|------------|:---------|:-------:|
| 25.0       | 0.0      | 124245  |
| 5.0        | 0.0      | 156491  |
| 1.0        | 0.0      | 183065  |

- 焼きなましの最初の温度が大きいほど収束に時間がかかる(それはそう)
- つまりやっぱり反復回数が足りてないんじゃねという話に

#### pragma オプション
- コードテストでは160000回くらいから175000回くらいなので+15000回
- 案外バカにできない気がする
- +6000点くらい　多少だが付けるべき(高速化出来てる場合確実にスコアが下がることはないので)
- やっぱりほとんど変わらないかもしれない

#### どの部分に処理がかかっているか(プロファイラ的な)
- 1000回の反復ごとにmodify,connect,score計算のどれにかかっているかチェック
- moveだけ100倍くらい小さい
- おそらく、modifyはO(K)(定数倍100かかってるけど)で、残りはO(N^2)なため

#### modify検証
- 変更前後で比べる
- どっちも山登り法(start_temp=end_temp=0)
- 今のやつが203211点,203313点(同一コード)
- 昔のやつが202742点
- あんまり変わらん
- そもそも提出ごとにどのくらいスコアが変動するのか調べてなかった
- 1000点くらいしか変わらない(Seed値同じだし)

### 2022/08/13

#### connect 関数を変更する
- connect_bfsを実装
- サーバーを一つ見つけて、そこから幅優先探索的に増やしていく
- 連結成分の個数は大きくなりそうな気がするが、つなげにくくなる場合もありそうでどうなるか……
- 233737 点(めっちゃ伸びた、すごい)
- なお焼きなまし法ではなく山登り法(start_temp=10,end_temp=0で151983点)
- 山登り法の反復回数がかなり減っているのでこのBFSの高速化も割と効果ありそう
- 余談
    - サンプルコードの設計がかなり賢いなという感じがする
    - Solver構造体内の各関数をいじっていくだけで割とスコアが上がるので初心者的には取り組みやすい

#### BFS 高速化
- 絶対にまずこれからやるべき

### 2022/08/14

#### servloc, servidの追加
- こいつらはBFSの高速化に必要
- servlocはサーバーidを入れると位置を返してくれる
    - サーバーの種類と何番目かをまとめてintで持っているのでややこしい
    - 例えばサーバー2で76番目(0-indexed)だったら176となる
    - 位置の持ち方も、(i, j) を `(i << 6) | j` と持っているのでややこしい
- servidは位置を入れるとidを返してくれる(servlocの逆関数)
    - サーバーidと位置の持ち方は変わらない
- こいつらを考慮してmove,modifyを変更
- 高速化はできていると思ったがスコアは上がらず(231997点)
- $ N $ と $ K $ のバランスで調整したほうが良さそう


### 疑問・ToDo等
- modifyとmove高速化
    - 初期ランダム解の生成部分はあきらかに高速化できる(わざわざfield[i][j]=='0'をチェックしてるのは無駄)
    - while(true)
- **connect 変更**
    - 今のところmove(modify)にランダム性を持たせてconnectは決定的アルゴリズムにしているが、両方ランダム性を持たせたり、connectも少しずつ変えるようにしたらどうなるだろう
    - 割り算減らす、メモリ節約
- スクリプト書いていろんなテストケースに対して自動で処理したい
    - 提出では総得点しか見れないので、実は問題サイズごとに処理を変えたほうが良いものもありそう(pragmaなど)
        - BFSもそうな気がする(直感的にはサーバが密だとより効果的な気がする)
- ある盤面に対し、一切移動できないとしたときの評価スコアの最大値は計算できるのか?
    - フローなど
- パラメータ弄りの候補
    - start_temp, end_temp, prob(modify関数の)
- 論文を読む?

### 一般的なこと
- 設計はこれからもマネできると感じた
    - Solver構造体に入力を渡して、solve_○○関数で解く
    - 答えの出力関数(print_answer)、答えの構造体(MoveAction,ConnectAction,Result)を用意する
    - 初期解の作り方(操作を全てランダムに決める)
    - 評価関数はしっかり(かつ忠実に)作る
- assertはバグを発見できるので積極的に書く
    - 遅くなってるかもしれないけど
- 2変数関数の焼きなまし法について(今回ならmoveとconnectがそれに該当)
    - ランダム性をどのくらい出すべきなのか
    - 収束性について

### 参考文献



- [gasin's blog, 誰でもできる焼きなまし法][gasin]

[gasin]: https://gasin.hatenadiary.jp/entry/2019/09/03/162613

- [じじいのプログラミング, 焼きなまし法のコツ Ver. 1.2][shindannin]

[shindannin]: https://shindannin.hatenadiary.com/entry/20121224/1356364040

